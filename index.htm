<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦ç¿’å®¤ åœ¨å®¤çŠ¶æ³ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <style>
        /* CSS: å…¨ä½“ã®ãƒ‡ã‚¶ã‚¤ãƒ³ã¨ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f4f7f6;
            color: #333;
            margin: 0;
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 10px 0;
            border-bottom: 3px solid #ddd;
        }
        h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin: 0;
        }
        .update-info {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-top: 5px;
        }
        .room-grid {
            display: grid;
            gap: 20px;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }
        .room-card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            padding: 25px;
            position: relative;
            overflow: hidden;
            transition: transform 0.3s, opacity 0.3s;
        }
        .room-card.hidden {
            display: none;
        }
        .room-card.closed {
            opacity: 0.6;
            filter: grayscale(80%);
        }
        .room-name {
            font-size: 1.4em;
            font-weight: bold;
            color: #34495e;
            margin-bottom: 10px;
        }
        .status-line {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        .status-icon {
            font-size: 2em;
            margin-right: 10px;
        }
        .status-text {
            font-size: 1.1em;
            font-weight: 500;
            flex-grow: 1;
        }
        .remaining-label {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-bottom: 5px;
        }
        .remaining-seats {
            font-size: 3em;
            font-weight: 900;
            line-height: 1;
        }
        .remaining-seats span {
            font-size: 0.4em;
            font-weight: normal;
            margin-left: 5px;
        }
        /* æ··é›‘åº¦åˆ¥ã‚«ãƒ©ãƒ¼ */
        .empty { color: #27ae60; }    /* ç·‘ */
        .low { color: #f1c40f; }      /* é»„ */
        .medium { color: #e67e22; }   /* æ©™ */
        .high { color: #d35400; }     /* æ¿ƒã„æ©™ */
        .full { color: #c0392b; }     /* èµ¤ */

        /* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ */
        .progress-container {
            height: 10px;
            background-color: #ecf0f1;
            border-radius: 5px;
            margin-top: 15px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            border-radius: 5px;
            transition: width 0.5s ease-in-out;
        }
        .progress-bar.empty { background-color: #2ecc71; }
        .progress-bar.low { background-color: #f1c40f; }
        .progress-bar.medium { background-color: #e67e22; }
        .progress-bar.high, .progress-bar.full { background-color: #e74c3c; }

        .capacity-text {
            font-size: 0.9em;
            text-align: right;
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        /* ä¼‘é¤¨æ—¥ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        .closed-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            color: #c0392b;
            font-size: 1.5em;
            font-weight: bold;
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }

        /* ãƒ•ãƒƒã‚¿ãƒ¼ */
        .footer {
            text-align: center;
            margin-top: 40px;
            font-size: 0.8em;
            color: #bdc3c7;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>å­¦ç¿’å®¤ åœ¨å®¤çŠ¶æ³</h1>
        <div class="update-info">
            æœ€çµ‚æ›´æ–°: <span id="last-updated-time">--:--:--</span> (1åˆ†ã”ã¨ã«è‡ªå‹•æ›´æ–°)
        </div>
    </div>
    
    <div class="room-grid">
        <div class="room-card" id="roomA-card">
            <div class="closed-overlay" id="roomA-closed-overlay">å®šä¼‘æ—¥ãƒ»ä¼‘é¤¨</div>
            <div class="room-name">ç”Ÿæ¶¯å­¦ç¿’ã‚»ãƒ³ã‚¿ãƒ¼ (A)</div>
            <div class="status-line">
                <span class="status-icon" id="roomA-icon"></span>
                <span class="status-text" id="roomA-status-text"></span>
            </div>
            <div class="remaining-label">ç©ºå¸­æ•°</div>
            <div class="remaining-seats" id="roomA-remaining">--<span>å¸­</span></div>
            <div class="progress-container"><div class="progress-bar" id="roomA-progress" style="width: 0%;"></div></div>
            <div class="capacity-text">ç·å¸­æ•°: <span id="roomA-total-capacity">--</span></div>
        </div>

        <div class="room-card" id="roomB-card">
            <div class="closed-overlay" id="roomB-closed-overlay">å®šä¼‘æ—¥ãƒ»ä¼‘é¤¨</div>
            <div class="room-name">å‰µé€ é¤¨ (B)</div>
            <div class="status-line">
                <span class="status-icon" id="roomB-icon"></span>
                <span class="status-text" id="roomB-status-text"></span>
            </div>
            <div class="remaining-label">ç©ºå¸­æ•°</div>
            <div class="remaining-seats" id="roomB-remaining">--<span>å¸­</span></div>
            <div class="progress-container"><div class="progress-bar" id="roomB-progress" style="width: 0%;"></div></div>
            <div class="capacity-text">ç·å¸­æ•°: <span id="roomB-total-capacity">--</span></div>
        </div>

        <div class="room-card" id="roomC-card">
            <div class="closed-overlay" id="roomC-closed-overlay">å®šä¼‘æ—¥ãƒ»ä¼‘é¤¨</div>
            <div class="room-name">ã‚¢ãƒ«ãƒ© (C)</div>
            <div class="status-line">
                <span class="status-icon" id="roomC-icon"></span>
                <span class="status-text" id="roomC-status-text"></span>
            </div>
            <div class="remaining-label">ç©ºå¸­æ•°</div>
            <div class="remaining-seats" id="roomC-remaining">--<span>å¸­</span></div>
            <div class="progress-container"><div class="progress-bar" id="roomC-progress" style="width: 0%;"></div></div>
            <div class="capacity-text">ç·å¸­æ•°: <span id="roomC-total-capacity">--</span></div>
        </div>

        <div class="room-card hidden" id="roomD-card">
            <div class="closed-overlay" id="roomD-closed-overlay">å®šä¼‘æ—¥ãƒ»ä¼‘é¤¨</div>
            <div class="room-name">å›³æ›¸é¤¨ (D)</div>
            <div class="status-line">
                <span class="status-icon" id="roomD-icon"></span>
                <span class="status-text" id="roomD-status-text"></span>
            </div>
            <div class="remaining-label">ç©ºå¸­æ•°</div>
            <div class="remaining-seats" id="roomD-remaining">--<span>å¸­</span></div>
            <div class="progress-container"><div class="progress-bar" id="roomD-progress" style="width: 0%;"></div></div>
            <div class="capacity-text">ç·å¸­æ•°: <span id="roomD-total-capacity">--</span></div>
        </div>
    </div>
    
    <div class="footer">
        ãƒ‡ãƒ¼ã‚¿ã¯Google Apps Scriptã‚’é€šã˜ã¦å–å¾—ã•ã‚Œã¦ã„ã¾ã™ã€‚
    </div>

    <script>
        // â†“â†“â†“ ã‚ãªãŸã®Google Apps Scriptã§ç™ºè¡Œã•ã‚ŒãŸã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã®URLã«ç½®ãæ›ãˆã¦ãã ã•ã„ â†“â†“â†“
        // â˜…â˜…â˜… doGetApiã§ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸURLã‚’ã“ã“ã«è¨­å®šï¼ â˜…â˜…â˜…
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbylAL9f-k7mYys3LhPCKAaTq22_uiYZp0qpBFdT5qsTbELBPJFszpgOZ_5ZFvZFRWRO2w/exec'; 

        // å„æ–½è¨­ã®å®šä¼‘æ—¥æƒ…å ± (JavaScriptã®Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã®æ›œæ—¥: 0=æ—¥, 1=æœˆ, ..., 6=åœŸ)
        const HOLIDAYS = {
            'A': { dayOfWeek: 1, label: 'æœˆæ›œæ—¥' },
            'B': { dayOfWeek: 2, label: 'ç«æ›œæ—¥' },
            'C': { dayOfWeek: -1, label: 'å¹´æœ«å¹´å§‹' }, 
            'D': { dayOfWeek: -1, label: 'ä¸å®šæœŸ' }
        };

        /**
         * ç‰¹å®šã®æ—¥ä»˜ãŒæ–½è¨­ã®å®šä¼‘æ—¥ã«å½“ãŸã‚‹ã‹åˆ¤å®šã™ã‚‹
         */
        function isHoliday(roomId, date) {
            const holidayInfo = HOLIDAYS[roomId];
            if (!holidayInfo) return false;

            const day = date.getDay(); 

            if (holidayInfo.dayOfWeek !== undefined && holidayInfo.dayOfWeek >= 0 && day === holidayInfo.dayOfWeek) {
                return true;
            }
            return false;
        }

        /**
         * åœ¨å®¤äººæ•°ã¨ç·å¸­æ•°ã«åŸºã¥ã„ã¦è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
         */
        function updateRoomDisplay(id, occupants, capacity) {
            if (typeof occupants !== 'number' || typeof capacity !== 'number' || capacity === 0) {
                 document.getElementById(`room${id}-remaining`).innerHTML = '--<span>å¸­</span>';
                 document.getElementById(`room${id}-status-text`).textContent = 'ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ©ãƒ¼';
                 document.getElementById(`room${id}-icon`).textContent = 'â“';
                 document.getElementById(`room${id}-progress`).style.width = '0%';
                 document.getElementById(`room${id}-total-capacity`).textContent = capacity || '--';
                 return;
            }

            const iconEl = document.getElementById(`room${id}-icon`);
            const remainingEl = document.getElementById(`room${id}-remaining`);
            const progressEl = document.getElementById(`room${id}-progress`);
            const statusTextEl = document.getElementById(`room${id}-status-text`);
            const totalCapacityEl = document.getElementById(`room${id}-total-capacity`);

            const remaining = Math.max(0, capacity - occupants);
            const occupancyRate = (occupants / capacity) * 100;

            let statusClass;
            let icon;
            let statusText;

            if (occupancyRate < 20) {
                statusClass = 'empty';
                icon = 'ğŸŸ¢';
                statusText = 'ç©ºå¸­ã‚ã‚Š';
            } else if (occupancyRate < 50) {
                statusClass = 'low';
                icon = 'ğŸŸ¡';
                statusText = 'åˆ©ç”¨å¯èƒ½';
            } else if (occupancyRate < 80) {
                statusClass = 'medium';
                icon = 'ğŸŸ ';
                statusText = 'æ··é›‘ä¸­';
            } else if (occupancyRate < 100) {
                statusClass = 'high';
                icon = 'ğŸ”´';
                statusText = 'æº€å¸­ã«è¿‘ã„';
            } else {
                statusClass = 'full';
                icon = 'ğŸ”´';
                statusText = 'æº€å¸­';
            }

            // CSSã‚¯ãƒ©ã‚¹ã¨ãƒ†ã‚­ã‚¹ãƒˆã®æ›´æ–°
            remainingEl.className = `remaining-seats ${statusClass}`;
            remainingEl.innerHTML = `${remaining}<span>å¸­</span>`;
            iconEl.className = `status-icon ${statusClass}`;
            iconEl.textContent = icon;
            statusTextEl.textContent = statusText;
            
            // ç·å¸­æ•°ã®æ›´æ–°
            totalCapacityEl.textContent = capacity;

            // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®æ›´æ–°
            progressEl.className = `progress-bar ${statusClass}`;
            progressEl.style.width = `${Math.min(100, occupancyRate)}%`;
        }


        /**
         * GASã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã€ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’æ›´æ–°ã™ã‚‹ãƒ¡ã‚¤ãƒ³é–¢æ•°
         */
        async function fetchRoomStatus() {
            
            let roomData = [];
            try {
                // GASã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã®URLã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã€ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’JSONã¨ã—ã¦å–å¾—
                const response = await fetch(GAS_URL);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const rawData = await response.json(); 
                
                roomData = rawData.map(item => ({
                    room_id: item.ID, 
                    current_occupants: parseInt(item.occupants, 10) || 0,
                    total_capacity: parseInt(item.capacity, 10) || 0
                }));

            } catch (error) {
                console.error("ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
                document.getElementById('last-updated-time').textContent = 'å–å¾—å¤±æ•—';
                return; 
            }
            
            const now = new Date();
            const rooms = ['A', 'B', 'C', 'D'];

            rooms.forEach(id => {
                const card = document.getElementById(`room${id}-card`);
                const overlay = document.getElementById(`room${id}-closed-overlay`);
                const roomDatum = roomData.find(r => r.room_id === id);

                if (!roomDatum) {
                    return; 
                }

                // --- å®šä¼‘æ—¥ã®åˆ¤å®š ---
                if (isHoliday(id, now)) {
                    card.classList.add('closed');
                    if (overlay) overlay.style.display = 'flex';

                    // è¡¨ç¤ºå†…å®¹ã‚’ä¼‘é¤¨æ—¥ä»•æ§˜ã«ä¸Šæ›¸ã
                    document.getElementById(`room${id}-remaining`).innerHTML = '--<span>å¸­</span>';
                    document.getElementById(`room${id}-status-text`).textContent = `å®šä¼‘æ—¥: ${HOLIDAYS[id].label}`;
                    document.getElementById(`room${id}-total-capacity`).textContent = roomDatum.total_capacity || '--';
                    document.getElementById(`room${id}-icon`).textContent = 'âŒ'; 
                    
                    const progressBar = document.getElementById(`room${id}-progress`);
                    progressBar.style.width = '0%';
                    progressBar.className = 'progress-bar';

                    return;
                } 
                
                // å®šä¼‘æ—¥ã§ã¯ãªã„å ´åˆ
                card.classList.remove('closed');
                if (overlay) overlay.style.display = 'none';

                // --- å›³æ›¸é¤¨ (D) ã®è¡¨ç¤ºãƒ»éè¡¨ç¤ºåˆ¤å®š ---
                if (id === 'D') {
                    const validData = roomDatum.current_occupants >= 0 && roomDatum.total_capacity > 0;

                    if (validData) {
                        card.classList.remove('hidden'); 
                        updateRoomDisplay(id, roomDatum.current_occupants, roomDatum.total_capacity);
                    } else {
                        card.classList.add('hidden'); 
                    }
                    return; 
                }

                // --- ãã®ä»–å­¦ç¿’å®¤ (A, B, C) ã®åœ¨å®¤çŠ¶æ³æ›´æ–° ---
                if (roomDatum) {
                    updateRoomDisplay(id, roomDatum.current_occupants, roomDatum.total_capacity);
                }
            });

            // æœ€çµ‚æ›´æ–°æ™‚åˆ»ã®æ›´æ–°
            document.getElementById('last-updated-time').textContent = new Date().toLocaleTimeString('ja-JP');
        }

        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã¨1åˆ†ã”ã¨ã«æ›´æ–°
        document.addEventListener('DOMContentLoaded', () => {
            fetchRoomStatus();
            setInterval(fetchRoomStatus, 60000); // 60ç§’ (1åˆ†) ã”ã¨ã«æ›´æ–°
        });
    </script>
</body>
</html>
